<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Slaid: Memahami Plot Cerita (Versi Interaktif + AI)</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- Mobile Drag & Drop Polyfill -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/scroll-behaviour.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
        if (typeof MobileDragDrop !== 'undefined') {
            var options = {};
            if (MobileDragDrop.scrollBehaviour) {
                options.dragImageTranslateOverride = MobileDragDrop.scrollBehaviour.dragImageTranslateOverride;
            }
            MobileDragDrop.polyfill(options);
        }
    });
  </script>

  <style>
    body { box-sizing: border-box; }
    :root { --base-font: 18px; --content-width: 1200px; }
    html { font-size: var(--base-font); }
    body { font-family: 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif; background: #ffffff; color: #0b0f19; }

    .title { font-size: clamp(2rem, 2vw + 1.2rem, 3rem); line-height: 1.12; font-weight: 900; }
    .btn { border-radius: 14px; font-weight: 800; padding: .6rem 1rem; transition: all .2s ease; cursor: pointer; border: none; display: inline-flex; align-items: center; justify-content: center;}
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: #3b82f6; color: #fff; }
    .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
    .btn-ghost { background: rgba(0,0,0,.06); color: #0b0f19; }
    .btn-danger { background: #fee2e2; color: #991b1b; }
    .btn-danger:hover { background: #fecaca; }
    .btn-success { background: #22c55e; color: #fff; }
    .btn-success:hover { background: #16a34a; }
    
    /* AI Buttons */
    .btn-ai { background: linear-gradient(135deg, #8b5cf6 0%, #d946ef 100%); color: white; border: none; }
    .btn-ai:hover { filter: brightness(1.1); transform: translateY(-1px); }
    .btn-ai:disabled { opacity: 0.7; cursor: wait; }
    .btn-ai-dark { background: linear-gradient(135deg, #4c1d95 0%, #7e22ce 100%); color: white; border: none; }
    .btn-outline-ai { border: 2px solid #8b5cf6; color: #7c3aed; background: transparent; }
    .btn-outline-ai:hover { background: #f5f3ff; }

    .lesson-badge {
      width: 56px; height: 56px; border-radius: 50%;
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 1.5rem; flex-shrink: 0;
    }
    .obj-strip { position: sticky; top: 0; z-index: 30; backdrop-filter: saturate(1.2); background: rgba(255,255,255,0.9); border-bottom: 1px solid #e5e7eb; }
    
    textarea.answer {
      width: 100%; min-height: 100px; border-radius: 14px; border: 1px solid #e2e8f0;
      padding: .9rem 1rem; outline: none; font-family: inherit; transition: border-color 0.2s; resize: vertical;
    }
    textarea.answer:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.18); }

    .draggable {
      cursor: grab; user-select: none; background: white; border: 2px solid #3b82f6; color: #2563eb;
      padding: 0.5rem 1rem; border-radius: 999px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      touch-action: none; margin: 4px;
    }
    .draggable:active { cursor: grabbing; }
    .draggable.matched { background: #dcfce7; border-color: #22c55e; color: #15803d; cursor: default; pointer-events: none; }
    
    .drop-zone {
      border: 2px dashed #cbd5e1; background: #f8fafc; border-radius: 12px;
      min-height: 60px; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; position: relative; z-index: 10;
    }
    .drop-zone.drag-over { background: #eff6ff; border-color: #3b82f6; transform: scale(1.02); }
    .drop-zone.correct { border-style: solid; border-color: #22c55e; background: #f0fdf4; }

    .quiz-opt {
        width: 100%; text-align: left; padding: 1rem; margin-bottom: 0.5rem;
        border: 2px solid #e2e8f0; border-radius: 12px; font-weight: 600; transition: all 0.2s;
    }
    .quiz-opt:hover:not(:disabled) { background: #f1f5f9; border-color: #cbd5e1; }
    .quiz-opt.correct { background: #dcfce7; border-color: #22c55e; color: #14532d; }
    .quiz-opt.wrong { background: #fee2e2; border-color: #ef4444; color: #7f1d1d; }

    .vocab-helper { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
    .vocab-button {
      width: 60px; height: 60px; border-radius: 50%; background: #f97316; color: white; border: none;
      font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      display: flex; align-items: center; justify-content: center; transition: transform 0.2s;
    }
    .vocab-button:hover { transform: scale(1.1); }
    .vocab-panel {
      position: absolute; bottom: 80px; right: 0; width: 300px; max-height: 400px; background: white;
      border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); transform: translateY(20px); opacity: 0;
      pointer-events: none; transition: all 0.3s ease; display: flex; flex-direction: column; overflow: hidden;
    }
    .vocab-panel.show { transform: translateY(0); opacity: 1; pointer-events: all; }
    .hidden { display: none !important; }
    
    /* AI Response Box */
    .ai-response {
        background: #f0fdfa; border: 1px solid #ccfbf1; color: #115e59;
        padding: 1rem; border-radius: 0.75rem; margin-top: 1rem; font-size: 0.95rem;
        white-space: pre-line;
    }
    
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    
    .animate-fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .thinking-dots::after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
    @keyframes dots { 
        0%, 20% { color: rgba(255,255,255,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);} 
        40% { color: white; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);} 
        60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(0,0,0,0);} 
        80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white;} 
    }

    /* Camera Input Styling */
    .file-upload-wrapper {
        position: relative;
        width: 100%;
        height: 120px;
        border: 2px dashed #cbd5e1;
        border-radius: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
        transition: all 0.3s ease;
        overflow: hidden;
        cursor: pointer;
    }
    .file-upload-wrapper:hover { background: #eff6ff; border-color: #3b82f6; }
    .file-upload-wrapper input[type="file"] {
        position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 2000;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
        backdrop-filter: blur(4px);
    }
    .modal-overlay.show { opacity: 1; pointer-events: auto; }
    .modal-box {
        background: white; padding: 2rem; width: 90%; max-width: 400px;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        border-radius: 1.5rem; text-align: center;
    }

    /* Comparison Slide Styles */
    .diff-del { background-color: #fee2e2; text-decoration: line-through; color: #991b1b; padding: 0 2px; border-radius: 2px; }
    .diff-add { background-color: #dcfce7; font-weight: bold; color: #166534; padding: 0 2px; border-radius: 2px; }
    .arrow-divider { display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #cbd5e1; }
    @media (min-width: 768px) { .arrow-divider { transform: rotate(0deg); } }
    @media (max-width: 767px) { .arrow-divider { transform: rotate(90deg); margin: 10px 0; } }
    
    /* Tab Styles */
    .tab-btn { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; font-weight: 600; color: #64748b; transition: all 0.2s; }
    .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6; }
  </style>
</head>
<body class="bg-gray-50 flex flex-col h-screen overflow-hidden">

  <!-- Navbar -->
  <div class="obj-strip flex-none">
    <div class="mx-auto px-6 py-3 max-w-[1200px] flex items-center justify-between">
      <div class="flex items-center gap-3">
          <span class="lesson-badge text-xl">üèîÔ∏è</span>
          <div class="overflow-hidden">
              <div class="font-bold text-sm sm:text-base truncate">Bahasa Melayu: Plot Cerita</div>
              <div id="saveStatus" class="text-xs text-green-600 font-semibold hidden"><i class="fas fa-check-circle"></i> Disimpan</div>
          </div>
      </div>
      <button type="button" class="text-sm font-bold text-blue-600 whitespace-nowrap" onclick="document.getElementById('objContent').classList.toggle('hidden')">Objektif ‚ñº</button>
    </div>
    <div id="objContent" class="hidden bg-white border-b border-gray-200 pb-4 px-6 max-w-[1200px] mx-auto text-sm transition-all">
       <ul class="list-disc pl-5 space-y-1 mt-2 text-gray-700">
         <li>Mentakrifkan maksud plot.</li>
         <li>Menyusun 5 elemen plot pada Piramid Freytag.</li>
         <li>Menganalisis cerita pendek.</li>
       </ul>
    </div>
  </div>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto relative scroll-smooth" id="mainScroll">
    <div class="mx-auto px-4 sm:px-6 py-8 pb-32 max-w-[1200px]">
      <section id="stage" class="transition-opacity duration-300"></section>
    </div>
  </main>

  <!-- Footer Navigation -->
  <div class="bg-white border-t border-gray-200 p-4 flex-none z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
    <div class="mx-auto max-w-[1200px] flex items-center justify-between gap-4">
        <div class="flex gap-2" id="dots"></div>
        <div class="flex gap-3">
            <button type="button" id="prevBtn" class="btn btn-ghost" onclick="changeSlide(-1)" title="Tekan kekunci Kiri">‚Üê</button>
            <button type="button" id="nextBtn" class="btn btn-primary" onclick="changeSlide(1)" title="Tekan kekunci Kanan">Seterusnya ‚Üí</button>
        </div>
    </div>
  </div>

  <!-- Vocab Helper -->
  <div class="vocab-helper">
    <div id="vocabPanel" class="vocab-panel">
      <div class="flex bg-gray-100 text-xs font-bold text-gray-500 border-b">
        <button type="button" class="flex-1 p-3 hover:bg-white hover:text-orange-500 transition" onclick="renderVocab('istilah')">ISTILAH</button>
        <button type="button" class="flex-1 p-3 hover:bg-white hover:text-orange-500 transition" onclick="renderVocab('kata_kunci')">KATA KUNCI</button>
      </div>
      <div id="vocabList" class="p-4 overflow-y-auto flex-1 space-y-2 text-sm h-64"></div>
    </div>
    <button type="button" class="vocab-button" onclick="toggleVocab()" aria-label="Buka Kamus">
        <i class="fas fa-book-open"></i>
    </button>
  </div>

  <!-- API Key Modal -->
  <div id="apiKeyModal" class="modal-overlay">
      <div class="modal-box animate-fade-in">
          <div class="text-4xl mb-4 bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto text-purple-600">üîë</div>
          <h3 class="text-xl font-bold mb-2 text-gray-800">API Key Diperlukan</h3>
          <p class="text-gray-500 mb-6 text-sm leading-relaxed">Untuk menggunakan ciri AI Pintar ini, sila masukkan Google Gemini API Key anda.</p>
          <input type="password" id="modalKeyInput" class="w-full p-4 border-2 border-gray-200 rounded-xl mb-4 text-sm font-mono focus:border-purple-500 outline-none transition" placeholder="Tampal API Key di sini...">
          <div class="flex gap-3 justify-center">
              <button onclick="closeApiKeyModal()" class="btn btn-ghost text-gray-500 hover:bg-gray-100 w-full">Batal</button>
              <button onclick="saveApiKeyFromModal()" class="btn btn-primary bg-purple-600 hover:bg-purple-700 w-full shadow-lg text-white">Simpan</button>
          </div>
      </div>
  </div>

  <script>
    // AI Config
    let apiKey = "AIzaSyAY77Tlhy4xa5E5V3ltI1TPKvGtcf_BJmE"; 
    
    const GOOGLE_SCRIPT_URL = ""; 

    let state = {
      slideIdx: 0,
      name: '',
      answers: {},
      dragScore: 0,
      uploadedImageBase64: null,
      scannedText: "",
      studioTab: 'bina' // 'bina' or 'bedah'
    };
    
    const saved = localStorage.getItem('plot_lesson_data');
    if(saved) {
        try { 
            state = { ...state, ...JSON.parse(saved) }; 
            state.slideIdx = 0; 
        } catch(e) { console.error('Error loading save'); }
    }

    function updateApiKey(val) {
        apiKey = val.trim();
        localStorage.setItem('gemini_api_key', apiKey);
    }

    const slides = [
      // 0: Intro
      {
        type: 'title',
        title: 'Memahami Plot Cerita',
        subtitle: 'Pelajaran Interaktif Bahasa Melayu',
        doNow: {
          title: '‚è±Ô∏è Do Now: Set Induksi (2 Minit)',
          prompt: 'Fikirkan satu filem atau novel kegemaran anda. Apakah babak atau peristiwa paling cemas (Klimaks) dalam cerita tersebut?',
          imageSrc: 'Thanos_really_snapped_his_fing.png' 
        }
      },
      // 1: Quiz
      {
        type: 'content_quiz',
        title: 'Apa itu Plot?',
        content: 'Plot ialah susunan peristiwa dalam cerita yang dikaitkan oleh sebab dan akibat. Tanpa plot, tiada cerita, hanya koleksi kejadian rawak.',
        quiz: {
          q: 'Manakah antara berikut merupakan definisi plot yang paling tepat?',
          options: ['Nama watak dalam cerita', 'Tempat kejadian cerita', 'Susunan peristiwa cerita', 'Tajuk sebuah buku'],
          ans: 2
        }
      },
      // 2: Drag Drop
      {
        type: 'drag_drop',
        title: 'Bina Piramid Plot',
        desc: 'Seret label ke kotak yang betul untuk melengkapkan graf plot cerita.',
        items: [
            { id: 'permulaan', label: 'Permulaan', target: 1 },
            { id: 'perkembangan', label: 'Perkembangan', target: 2 },
            { id: 'konflik', label: 'Konflik', target: 3 },
            { id: 'kemuncak', label: 'Kemuncak', target: 4 },
            { id: 'peleraian', label: 'Peleraian', target: 5 }
        ]
      },
      // 3: Video
      {
        type: 'video',
        title: 'Contoh Plot dalam Video',
        videoSrc: 'video_plot.mp4', 
        desc: 'Tonton dan cuba kenal pasti bila konflik bermula.'
      },
      // 4: Case Study
      {
        type: 'case_study',
        title: 'Plot Iklan ‚ÄúGiving‚Äù ‚Äì TrueMove H',
        points: [
            { title: '1. Permulaan', text: 'Seorang budak lelaki kecil ditangkap mencuri ubat dari sebuah farmasi. Pemilik kedai marah dan ingin menghukumnya. Seorang lelaki pemilik kedai makanan (kedai sup) melihat kejadian itu, membayar harga ubat tersebut dan memberikannya kepada budak itu.' },
            { title: '2. Perkembangan', text: 'Budak itu menerima bantuan tanpa berkata apa-apa. Lelaki pemilik kedai makanan terus melakukan kebaikan tanpa mengharapkan balasan. Masa berlalu selama 30 tahun.' },
            { title: '3. Konflik', text: 'Lelaki itu tiba-tiba rebah dan masuk hospital. Bil rawatan sangat tinggi. Anak perempuannya buntu dan sedih kerana tidak mampu membayar.' },
            { title: '4. Kemuncak', text: 'Anak perempuan menerima bil baharu yang tertulis: ‚ÄúPaid 30 years ago‚Ä¶ with a bowl of soup and kindness.‚Äù Doktor yang merawat ayahnya ialah budak yang pernah dibantunya.' },
            { title: '5. Peleraian', text: 'Ayahnya sedar. Iklan menutup dengan mesej: ‚ÄúGiving is the best communication.‚Äù Kebaikan kembali dalam bentuk yang lebih besar.' }
        ]
      },
      // 5: MERGED: Creative Writing + Text Analysis
      {
        type: 'creative_studio',
        title: '‚úçÔ∏è Studio Penulisan Kreatif',
        desc: 'Pilih mod: Bina cerita anda sendiri ATAU bedah cerita sedia ada menggunakan AI.',
        scenarioTitle: 'Situasi: "Misteri Pondok Lama"',
        scenarioDesc: 'Anda menyertai aktiviti merentas desa dan sesat di hutan. Anda terjumpa sebuah pondok usang yang didiami seorang nenek misteri. Apa yang anda lakukan?',
        inputs: [
            { id: 'cw_permulaan', label: '1. Permulaan', placeholder: 'Gambarkan suasana hutan, rasa sesat, dan terjumpa pondok usang...' },
            { id: 'cw_perkembangan', label: '2. Perkembangan', placeholder: 'Terangkan pertembungan dengan nenek misteri itu. Apa soalan yang ditanya?' },
            { id: 'cw_konflik', label: '3. Konflik', placeholder: 'Apakah masalah yang timbul? (Cth: Nenek itu minta bantuan ganjil, atau cuba menahan anda?)' },
            { id: 'cw_kemuncak', label: '4. Klimaks', placeholder: 'Detik paling cemas! Apa yang anda terpaksa lakukan untuk melepaskan diri?' },
            { id: 'cw_peleraian', label: '5. Peleraian', placeholder: 'Bagaimana anda keluar dari hutan? Adakah anda menceritakan tentang nenek itu kepada orang lain?' }
        ]
      },
      // 6: Camera Scan (Standalone again)
      {
        type: 'camera_scan',
        title: 'üì∏ Semakan Cikgu AI (Kamera)',
        desc: 'Ambil gambar karangan tulisan tangan anda. AI akan membaca teks (OCR) dan menyemak kesalahan.',
      },
      // 7: Comparison Slide
      {
        type: 'comparison',
        title: '‚ú® Analisis & Pemurnian',
        desc: 'Lihat bagaimana AI memurnikan ayat anda daripada Slaid 5 atau 6. Bandingkan draf asal dengan versi yang telah diperbaiki.',
      }
    ];

    const vocabData = {
      istilah: [['Plot','Jalan cerita'], ['Konflik','Masalah watak'], ['Klimaks','Puncak ketegangan']],
      kata_kunci: ['Menganalisis', 'Menghuraikan', 'Sebab & Akibat', 'Dilema', 'Integriti']
    };

    /* --- CORE FUNCTIONS --- */
    
    function init() {
        const storedKey = localStorage.getItem('gemini_api_key');
        if(storedKey && storedKey.length > 10) apiKey = storedKey;

        renderSlide();
        renderVocab('istilah');
        if(state.name) document.getElementById('saveStatus').classList.remove('hidden');
    }

    function saveProgress() {
        localStorage.setItem('plot_lesson_data', JSON.stringify(state));
        const status = document.getElementById('saveStatus');
        status.classList.remove('hidden');
        status.innerHTML = '<i class="fas fa-sync fa-spin"></i> Menyimpan...';
        setTimeout(() => status.innerHTML = '<i class="fas fa-check-circle"></i> Disimpan', 800);
    }

    function resetData() {
        if(confirm('Adakah anda pasti? Semua jawapan akan dipadam.')) {
            localStorage.removeItem('plot_lesson_data');
            state.answers = {};
            state.name = '';
            state.uploadedImageBase64 = null;
            state.scannedText = "";
            location.reload();
        }
    }

    function changeSlide(dir) {
        const newIdx = state.slideIdx + dir;
        if(newIdx >= 0 && newIdx < slides.length) {
            state.slideIdx = newIdx;
            saveProgress();
            renderSlide();
            document.getElementById('mainScroll').scrollTop = 0;
        }
    }

    window.addEventListener('keydown', (e) => {
        if(['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
        if(e.key === 'ArrowLeft') changeSlide(-1);
        else if(e.key === 'ArrowRight') changeSlide(1);
    });

    /* --- MODAL FUNCTIONS --- */
    function closeApiKeyModal() { document.getElementById('apiKeyModal').classList.remove('show'); }
    function showApiKeyModal() { document.getElementById('apiKeyModal').classList.add('show'); setTimeout(() => document.getElementById('modalKeyInput').focus(), 100); }
    function saveApiKeyFromModal() {
        const input = document.getElementById('modalKeyInput');
        const val = input.value.trim();
        if(val.length > 5) {
            updateApiKey(val);
            closeApiKeyModal();
            alert("API Key disimpan! Sila tekan butang AI sekali lagi.");
        } else {
            alert("Sila masukkan key yang sah.");
        }
    }

    /* --- AI FUNCTIONS (GEMINI) --- */
    
    async function callGeminiAPI(prompt, btnId, outputDivId = null, isAppend = false, imageBase64 = null) {
        let currentKey = apiKey;
        if (!currentKey || currentKey.trim() === "" || currentKey === "TAMPAL_KEY_DI_SINI") { showApiKeyModal(); return null; }

        const btn = document.getElementById(btnId);
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="thinking-dots">Memproses</span>';
        btn.disabled = true;

        const modelsToTry = ['gemini-2.5-flash-preview-09-2025','gemini-1.5-flash'];
        
        try {
            let success = false; let resultText = "";
            const parts = [{ text: prompt }];
            if (imageBase64) {
                const base64Data = imageBase64.includes(',') ? imageBase64.split(',')[1] : imageBase64;
                parts.push({ inlineData: { mimeType: "image/jpeg", data: base64Data } });
            }

            for (const model of modelsToTry) {
                if (success) break;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${currentKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: parts }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (resultText) success = true;
                } catch (err) { if(err.message.includes("API key")) throw err; }
            }

            if (!success) throw new Error("Gagal memproses. Sila cuba lagi.");

            if(outputDivId) {
                 const outDiv = document.getElementById(outputDivId);
                 if(isAppend && outDiv.value !== undefined) {
                    const cur = outDiv.value.trim();
                    outDiv.value = cur ? cur + "\n\n" + resultText.trim() : resultText.trim();
                    saveAnswer(outputDivId.replace('text-',''), outDiv.value);
                 } else {
                    outDiv.innerHTML = resultText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    outDiv.classList.remove('hidden');
                 }
            }
            btn.innerHTML = originalText; btn.disabled = false;
            return resultText;

        } catch (error) {
            alert("Ralat AI: " + error.message);
            btn.innerHTML = originalText; btn.disabled = false; return null;
        }
    }

    /* --- SLIDE 5: CREATIVE STUDIO FUNCTIONS --- */
    function askGemini(label, inputId) {
        const prompt = `Kamu adalah pembantu penulisan kreatif. Tajuk: "Misteri Pondok Lama". Tugasan: Berikan satu idea pendek (maksimum 2 ayat) untuk "${label}". Bahasa: Bahasa Melayu.`;
        callGeminiAPI(prompt, `btn-ai-${inputId}`, `text-${inputId}`, true);
    }

    function checkMyStory() {
        const inputs = ['permulaan','perkembangan','konflik','kemuncak','peleraian'].map(id => document.getElementById('text-cw_'+id)?.value || "(Tiada)").join('\n');
        if(inputs.length < 20) { alert("Tulis cerita dahulu."); return; }
        // Update scannedText for Slide 7 usage
        state.scannedText = inputs; 
        saveProgress();
        const prompt = `Semak plot cerita pelajar ini (Piramid Freytag):\n${inputs}\nBerikan komen ringkas dalam BM.`;
        callGeminiAPI(prompt, 'btn-check-story', 'story-feedback');
    }

    function switchStudioTab(tab) {
        state.studioTab = tab;
        document.getElementById('tab-bina').classList.toggle('active', tab==='bina');
        document.getElementById('tab-bedah').classList.toggle('active', tab==='bedah');
        document.getElementById('content-bina').classList.toggle('hidden', tab!=='bina');
        document.getElementById('content-bedah').classList.toggle('hidden', tab!=='bedah');
    }

    function analyzeStoryStudio() {
        const text = document.getElementById('analyze-text').value;
        if(!text || text.length < 10) { alert("Sila masukkan teks cerita."); return; }
        // Update scannedText for Slide 7 usage
        state.scannedText = text;
        saveProgress();
        const prompt = `Analisis cerita pendek berikut kepada 5 elemen plot (Permulaan, Perkembangan, Konflik, Kemuncak, Peleraian). Format HTML <ul>. Gunakan Bahasa Melayu.\nTeks: "${text}"`;
        callGeminiAPI(prompt, 'btn-analyze-studio', 'studio-result');
    }

    /* --- SLIDE 6: CAMERA FUNCTIONS --- */
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('img-preview').src = e.target.result;
                document.getElementById('img-preview').classList.remove('hidden');
                document.getElementById('img-placeholder').classList.add('hidden');
                state.uploadedImageBase64 = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    async function checkGrammarFromImage() {
        if (!state.uploadedImageBase64) { alert("Sila ambil gambar dahulu."); return; }
        
        const prompt = `
        1. Baca teks dalam imej ini (OCR) dan berikan teks mentah sahaja dahulu.
        2. Kemudian, di bawahnya, senaraikan kesalahan tatabahasa/ejaan dalam format HTML list <ul>.
        3. Gunakan pemisah "---PEMISAH---" antara teks mentah dan analisis.
        `;
        
        const fullResult = await callGeminiAPI(prompt, 'btn-check-image', null, false, state.uploadedImageBase64);
        
        if(fullResult) {
            const parts = fullResult.split("---PEMISAH---");
            let rawText = parts[0].trim().replace(/```/g, '');
            let analysis = parts[1] ? parts[1].trim() : "Tiada analisis dikesan.";
            
            // Update scannedText for Slide 7
            state.scannedText = rawText;
            document.getElementById('scanned-text-area').value = rawText;
            document.getElementById('ocr-result').innerHTML = analysis;
            document.getElementById('ocr-result').classList.remove('hidden');
            saveProgress();
        }
    }

    function updateScannedText(val) {
        state.scannedText = val;
        saveProgress();
    }

    /* --- SLIDE 7: COMPARISON --- */
    async function generateComparison() {
        if(!state.scannedText || state.scannedText.length < 5) {
            alert("Tiada teks dikesan. Sila tulis cerita di Slaid 5 atau imbas gambar di Slaid 6.");
            return;
        }

        const prompt = `
        Bertindak sebagai Cikgu Bahasa Melayu.
        Berikut adalah karangan pelajar: "${state.scannedText}"

        Tugasan 1: Tulis semula karangan ini supaya menjadi gramatis, matang, dan menarik (Versi Sempurna).
        Tugasan 2: Sediakan versi "Diff" dalam format HTML sahaja. 
           - Bungkus perkataan yang dibuang/salah dengan <span class="diff-del">...</span>
           - Bungkus perkataan yang ditambah/dibetulkan dengan <span class="diff-add">...</span>
        
        Format Jawapan (Wajib ikut ini):
        ---VERSI_SEMPURNA---
        [Teks sempurna di sini]
        ---VERSI_DIFF---
        [HTML Diff di sini]
        `;

        const res = await callGeminiAPI(prompt, 'btn-generate-comparison');
        if(res) {
            const parts = res.split(/---VERSI_SEMPURNA---|---VERSI_DIFF---/);
            if(parts.length >= 3) {
                const diffHtml = parts[2].trim().replace(/```html|```/g, ''); 
                document.getElementById('comp-before').innerHTML = state.scannedText; 
                document.getElementById('comp-after').innerHTML = diffHtml;
                document.getElementById('comp-container').classList.remove('hidden');
            } else {
                alert("Format jawapan AI tidak lengkap. Sila cuba lagi.");
            }
        }
    }

    /* --- RENDERERS --- */

    function renderSlide() {
        const s = slides[state.slideIdx];
        const stage = document.getElementById('stage');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const dots = document.getElementById('dots');

        prevBtn.disabled = state.slideIdx === 0;
        nextBtn.innerText = state.slideIdx === slides.length - 1 ? 'Tamat' : 'Seterusnya ‚Üí';
        dots.innerHTML = slides.map((_, i) => `<div class="w-2.5 h-2.5 rounded-full ${i === state.slideIdx ? 'bg-blue-600' : 'bg-gray-300'}"></div>`).join('');

        let html = '';

        if(s.type === 'title') {
             html = `
            <div class="text-center py-6 animate-fade-in max-w-3xl mx-auto">
                <div class="lesson-badge mx-auto mb-4 w-20 h-20 text-3xl shadow-lg">üèîÔ∏è</div>
                <h1 class="title text-slate-800 mb-2 text-4xl tracking-tight">${s.title}</h1>
                <p class="text-lg text-slate-500 mb-6 font-medium">${s.subtitle}</p>
                <div class="mb-6 max-w-md mx-auto">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 text-left ml-1">Nama Murid:</label>
                    <input type="text" class="w-full p-4 border border-gray-300 rounded-xl bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition shadow-sm text-lg" 
                        placeholder="Taip nama penuh anda..." value="${state.name}" oninput="state.name=this.value; saveProgress()">
                </div>
                <!-- API Key Input Re-added -->
                <div class="mb-8 max-w-md mx-auto bg-gray-100 p-4 rounded-xl border border-gray-200">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 text-left ml-1 flex justify-between"><span>Google AI API Key:</span><i class="fas fa-key text-gray-400"></i></label>
                    <input type="password" class="w-full p-3 border border-gray-300 rounded-lg bg-white text-gray-600 text-sm font-mono focus:border-blue-500 outline-none transition" value="${apiKey}" oninput="updateApiKey(this.value)" placeholder="Masukkan API Key...">
                    <div class="text-[10px] text-gray-400 text-left mt-1 italic">* Kunci diperlukan untuk ciri AI di Slaid 5, 6 & 7.</div>
                </div>

                <div class="bg-indigo-50 border-2 border-indigo-100 rounded-2xl p-6 text-left shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 right-0 bg-indigo-200 text-indigo-800 text-xs font-bold px-3 py-1 rounded-bl-xl">AKTIVITI WAJIB</div>
                    <h3 class="font-bold text-indigo-900 mb-2 flex items-center gap-2 text-lg">${s.doNow.title}</h3>
                    <p class="text-indigo-800 text-base mb-4 leading-relaxed">${s.doNow.prompt}</p>
                    <div class="w-full bg-white rounded-xl border border-indigo-200 overflow-hidden flex items-center justify-center min-h-[200px]"><img src="${s.doNow.imageSrc}" class="w-full h-auto object-contain max-h-[300px]" alt="Do Now Image"></div>
                </div>
            </div>`;
        }
        else if(s.type === 'content_quiz') {
             html = `
            <div class="max-w-4xl mx-auto animate-fade-in">
                <h2 class="title mb-6">${s.title}</h2>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-r-xl mb-8 shadow-sm"><p class="text-lg leading-relaxed text-blue-900 font-medium">${s.content}</p></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <div class="flex items-center gap-3 mb-4"><span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Kuiz Pantas</span><h3 class="font-bold text-lg">ü§î Uji Minda</h3></div>
                    <p class="mb-4 text-gray-700 font-medium text-lg">${s.quiz.q}</p>
                    <div class="space-y-2">${s.quiz.options.map((opt, i) => `<button type="button" onclick="checkQuiz(this, ${i}, ${s.quiz.ans})" class="quiz-opt text-left w-full text-base">${String.fromCharCode(65+i)}. ${opt}</button>`).join('')}</div>
                    <p id="quizFeedback" class="mt-3 text-lg font-bold hidden"></p>
                </div>
            </div>`;
        }
        else if(s.type === 'drag_drop') {
            const shuffledItems = [...s.items].sort(() => Math.random() - 0.5);
            const offsetClasses = ['md:pb-0', 'md:pb-16', 'md:pb-32', 'md:pb-48', 'md:pb-0'];
            const polylinePoints = "50,250 250,180 450,120 650,50 850,250";
            html = `
            <div class="text-center max-w-6xl mx-auto animate-fade-in h-full flex flex-col">
                <h2 class="title mb-2 text-2xl">${s.title}</h2>
                <p class="text-gray-500 mb-4">${s.desc}</p>
                <div class="flex flex-wrap justify-center gap-3 mb-4 p-4 bg-gray-50 rounded-xl border border-dashed border-gray-300 min-h-[70px]" id="dragSource">
                    ${shuffledItems.map(item => `<div draggable="true" ondragstart="drag(event)" id="${item.id}" class="draggable text-sm md:text-base shadow-sm" data-target="${item.target}">${item.label}</div>`).join('')}
                </div>
                <div class="relative flex-1 min-h-[350px] mt-4">
                    <svg class="absolute bottom-[60px] left-0 w-full h-full -z-10 opacity-30 hidden md:block" preserveAspectRatio="none" viewBox="0 0 900 300">
                        <polyline points="${polylinePoints}" fill="none" stroke="#3b82f6" stroke-width="4" stroke-dasharray="10,5"/>
                    </svg>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2 md:gap-4 items-end h-full pb-4 relative z-10">
                        ${[1,2,3,4,5].map((num, i) => `<div class="flex flex-col gap-2 h-full justify-end ${offsetClasses[i]} transition-all duration-500"><div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">FASA ${i+1}</div><div class="drop-zone w-full bg-white/90 backdrop-blur shadow-sm border-2 border-slate-200" ondrop="drop(event)" ondragover="allowDrop(event)" data-zone="${num}"><span class="text-gray-300 text-2xl font-bold pointer-events-none">${num}</span></div><div class="h-4 w-0.5 bg-gray-300 mx-auto md:hidden ${i===4 ? 'hidden':''}"></div></div>`).join('')}
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-4 italic block md:hidden">* Paparan carta optimum pada skrin komputer.</p>
            </div>`;
        }
        else if(s.type === 'video') {
             let playerHtml = s.videoId ? `<iframe class="w-full h-full" src="https://www.youtube.com/embed/${s.videoId}?rel=0&modestbranding=1" frameborder="0" allowfullscreen></iframe>` : `<video class="w-full h-full object-contain bg-black" controls><source src="${s.videoSrc}" type="video/mp4">Maaf, pelayar anda tidak menyokong video.</video>`;
             html = `
            <div class="text-center max-w-4xl mx-auto animate-fade-in">
                <h2 class="title mb-6">${s.title}</h2>
                <div class="aspect-video bg-black rounded-2xl mb-6 overflow-hidden shadow-xl border-4 border-gray-800 relative">${playerHtml}</div>
                <div class="bg-orange-50 p-4 rounded-xl text-left border border-orange-100 flex gap-4 items-start"><span class="text-2xl">üëÄ</span><div><div class="font-bold text-orange-800 text-sm uppercase mb-1">Arahan:</div><p class="text-orange-900 font-medium">${s.desc}</p></div></div>
            </div>`;
        }
        else if(s.type === 'case_study') {
            html = `
            <div class="max-w-5xl mx-auto h-full flex flex-col animate-fade-in">
                <div class="mb-6 text-center"><h2 class="title mb-2">${s.title}</h2><p class="text-gray-500">Analisis struktur plot berdasarkan iklan tersebut.</p></div>
                <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden flex flex-col flex-1">
                    <div class="bg-indigo-50 p-4 border-b border-indigo-100 font-bold text-indigo-800 flex justify-between sticky top-0 z-10"><span>Jalan Cerita</span><span>üìù 5 Fasa Plot</span></div>
                    <div class="p-6 overflow-y-auto custom-scroll space-y-6">
                        ${s.points.map((pt, i) => `<div class="flex gap-4 items-start"><div class="flex-none w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center font-bold text-white text-lg shadow-md ${i===0?'bg-green-500':i===1?'bg-blue-500':i===2?'bg-red-500':i===3?'bg-purple-500':'bg-orange-500'}">${i+1}</div><div><h4 class="font-bold text-gray-800 text-lg mb-1">${pt.title}</h4><p class="text-gray-600 text-base leading-relaxed">${pt.text}</p></div></div>`).join('')}
                    </div>
                </div>
            </div>`;
        }
        else if(s.type === 'creative_studio') {
             // MERGED SLIDE: Creative Writing + Text Lab
             html = `
             <div class="max-w-6xl mx-auto h-full flex flex-col animate-fade-in">
                 <div class="text-center mb-4">
                    <h2 class="title text-3xl mb-1">${s.title}</h2>
                    <p class="text-gray-500">${s.desc}</p>
                 </div>
                 
                 <div class="bg-white border border-gray-200 rounded-2xl shadow-sm flex flex-col flex-1 overflow-hidden">
                     <!-- Tabs -->
                     <div class="flex border-b border-gray-200 bg-gray-50">
                         <button onclick="switchStudioTab('bina')" id="tab-bina" class="tab-btn ${state.studioTab==='bina'?'active':''} flex-1">üèóÔ∏è Bina Cerita (Piramid)</button>
                         <button onclick="switchStudioTab('bedah')" id="tab-bedah" class="tab-btn ${state.studioTab==='bedah'?'active':''} flex-1">üî¨ Bedah Cerita (Teks Bebas)</button>
                     </div>

                     <!-- Content A: BINA (The old Creative Writing) -->
                     <div id="content-bina" class="flex-1 overflow-y-auto custom-scroll p-6 ${state.studioTab==='bina'?'':'hidden'}">
                        <div class="flex flex-col lg:flex-row gap-6">
                            <!-- Scenario Card -->
                            <div class="lg:w-1/3 flex-none">
                                <div class="bg-purple-600 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden mb-4">
                                    <div class="absolute top-0 right-0 opacity-10 transform translate-x-4 -translate-y-4"><i class="fas fa-tree text-9xl"></i></div>
                                    <h3 class="font-bold text-xl mb-3 border-b border-purple-400 pb-2"><i class="fas fa-bolt mr-2"></i>${s.scenarioTitle}</h3>
                                    <p class="text-purple-100 leading-relaxed text-base">${s.scenarioDesc}</p>
                                </div>
                                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center">
                                    <p class="text-sm text-gray-500 mb-2">Dah siap? Minta AI semak plot anda.</p>
                                    <button id="btn-check-story" onclick="checkMyStory()" class="btn btn-ai-dark w-full py-3 shadow-md"><i class="fas fa-clipboard-check mr-2"></i> Semak Plot Saya</button>
                                    <div id="story-feedback" class="ai-response hidden text-left text-sm mt-3 bg-purple-50 border-purple-100 text-purple-900"></div>
                                </div>
                            </div>
                            <!-- Inputs -->
                            <div class="lg:w-2/3 space-y-6">
                                ${s.inputs.map((inp, i) => `
                                    <div class="relative group">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="block text-sm font-bold text-gray-700 uppercase flex items-center gap-2"><span class="bg-gray-200 text-gray-600 w-6 h-6 rounded-full flex items-center justify-center text-xs">${i+1}</span>${inp.label}</label>
                                            <button type="button" id="btn-ai-${inp.id}" onclick="askGemini('${inp.label}', '${inp.id}')" class="btn-ai px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm flex items-center gap-1"><i class="fas fa-magic"></i> <span>Idea AI</span></button>
                                        </div>
                                        <textarea id="text-${inp.id}" class="answer w-full bg-gray-50 focus:bg-white border border-gray-300 focus:border-purple-500 rounded-xl p-4 text-base transition-all shadow-sm min-h-[100px] leading-relaxed" placeholder="${inp.placeholder}" oninput="saveAnswer('${inp.id}', this.value)">${state.answers[inp.id] || ''}</textarea>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                     </div>

                     <!-- Content B: BEDAH (The old AI Lab) -->
                     <div id="content-bedah" class="flex-1 overflow-y-auto custom-scroll p-6 ${state.studioTab==='bedah'?'':'hidden'}">
                        <div class="max-w-3xl mx-auto flex flex-col h-full">
                             <div class="flex items-center gap-2 mb-2"><i class="fas fa-quote-left text-gray-300"></i><span class="font-bold text-gray-700 text-sm">TAMPAL CERITA PENDEK DI SINI:</span></div>
                             <textarea id="analyze-text" class="w-full flex-1 min-h-[300px] bg-slate-50 border border-slate-200 rounded-xl p-4 focus:border-blue-500 outline-none resize-none mb-4" placeholder="Contoh: Sang Kancil sedang berjalan di hutan apabila tiba-tiba..."></textarea>
                             <button id="btn-analyze-studio" onclick="analyzeStoryStudio()" class="btn btn-ai w-full py-3 text-lg shadow-lg mb-4"><i class="fas fa-microscope mr-2"></i> Analisis Struktur Plot</button>
                             <div id="studio-result" class="ai-response hidden min-h-[100px] border-dashed border-2 border-gray-300 bg-gray-50 text-gray-700"></div>
                        </div>
                     </div>
                 </div>
             </div>`;
        }
        else if(s.type === 'camera_scan') {
             // STANDALONE CAMERA SLIDE
             html = `
             <div class="max-w-3xl mx-auto animate-fade-in h-full flex flex-col">
                 <h2 class="title mb-2 text-center text-3xl">${s.title}</h2>
                 <p class="text-center text-gray-500 mb-6 px-4">${s.desc}</p>
                 
                 <div class="flex-1 bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col gap-4">
                    <div class="file-upload-wrapper" id="upload-zone">
                        <div id="img-placeholder" class="text-center p-4">
                            <i class="fas fa-camera text-4xl text-blue-300 mb-2"></i>
                            <p class="font-bold text-gray-500">Ketik untuk ambil gambar<br>atau pilih fail</p>
                        </div>
                        <img id="img-preview" class="preview-image hidden" />
                        <input type="file" accept="image/*" capture="environment" onchange="handleImageUpload(event)">
                    </div>

                    <button id="btn-check-image" onclick="checkGrammarFromImage()" class="btn btn-ai w-full py-4 text-lg shadow-lg">
                        <i class="fas fa-wand-magic-sparkles mr-2"></i> Semak Kesalahan
                    </button>
                    
                    <div class="mt-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Teks Hasil Imbasan (Boleh diedit):</label>
                        <textarea id="scanned-text-area" class="w-full p-3 border border-gray-300 rounded-lg text-sm bg-gray-50 h-32" oninput="updateScannedText(this.value)">${state.scannedText || ''}</textarea>
                    </div>

                    <div id="ocr-result" class="ai-response hidden flex-1 min-h-[150px] border-dashed border-2 border-green-200 bg-green-50 text-gray-800 overflow-y-auto p-4 leading-relaxed text-sm"></div>
                 </div>
                 <div class="text-center mt-4">
                    <button type="button" class="btn btn-danger text-sm py-2 px-4" onclick="resetData()"><i class="fas fa-trash-alt mr-2"></i> Mula Semula</button>
                 </div>
             </div>`;
        }
        else if(s.type === 'comparison') {
             const hasText = state.scannedText && state.scannedText.length > 5;
             html = `
             <div class="max-w-5xl mx-auto animate-fade-in h-full flex flex-col">
                 <h2 class="title mb-2 text-center">${s.title}</h2>
                 <p class="text-center text-gray-500 mb-6">${s.desc}</p>
                 
                 ${!hasText ? 
                   `<div class="text-center p-10 bg-yellow-50 border border-yellow-200 rounded-xl text-yellow-800">
                      <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                      <p class="font-bold text-lg">Tiada Teks Dijumpai</p>
                      <p>Sila kembali ke <strong>Slaid 5 atau 6</strong> dan tulis/imbas cerita anda dahulu.</p>
                      <button onclick="changeSlide(-1)" class="btn btn-primary mt-4">Kembali</button>
                   </div>` 
                   : 
                   `<div class="flex flex-col h-full gap-4">
                        <div class="text-center">
                            <button id="btn-generate-comparison" onclick="generateComparison()" class="btn btn-ai text-lg shadow-lg px-8 py-3">
                                <i class="fas fa-magic mr-2"></i> Jana Pemurnian AI
                            </button>
                        </div>
                        
                        <div id="comp-container" class="hidden flex flex-col md:flex-row gap-6 flex-1 min-h-0">
                             <!-- Before Box (Raw Text) -->
                             <div class="flex-1 flex flex-col h-full overflow-hidden">
                                 <div class="bg-red-100 text-red-800 px-4 py-2 rounded-t-xl font-bold text-sm border-b border-red-200 flex-none">
                                     <i class="fas fa-pen-nib mr-2"></i> Versi Asal (Pelajar)
                                 </div>
                                 <div id="comp-before" class="bg-red-50 p-6 rounded-b-xl border border-red-100 flex-1 text-base leading-relaxed shadow-sm text-gray-700 overflow-y-auto custom-scroll"></div>
                             </div>
        
                             <!-- Arrow Divider -->
                             <div class="arrow-divider flex-none">
                                 <i class="fas fa-arrow-right"></i>
                             </div>
        
                             <!-- After Box (Diff/Perfect) -->
                             <div class="flex-1 flex flex-col h-full overflow-hidden">
                                 <div class="bg-green-100 text-green-800 px-4 py-2 rounded-t-xl font-bold text-sm border-b border-green-200 flex-none">
                                     <i class="fas fa-robot mr-2"></i> Versi Dimurnikan (AI)
                                 </div>
                                 <div id="comp-after" class="bg-green-50 p-6 rounded-b-xl border border-green-100 flex-1 text-base leading-relaxed shadow-md text-gray-800 relative overflow-y-auto custom-scroll"></div>
                             </div>
                        </div>
                   </div>`
                 }
             </div>`;
        }

        stage.innerHTML = html;
        stage.style.opacity = 0;
        void stage.offsetWidth;
        stage.style.opacity = 1;
    }

    function checkQuiz(btn, selectedIdx, correctIdx) {
        const feedback = document.getElementById('quizFeedback');
        const allBtns = btn.parentElement.querySelectorAll('button');
        allBtns.forEach(b => b.disabled = true);
        if(selectedIdx === correctIdx) {
            btn.classList.add('correct');
            feedback.innerHTML = "<i class='fas fa-check-circle'></i> Tepat sekali!";
            feedback.classList.remove('hidden', 'text-red-600'); feedback.classList.add('text-green-600');
        } else {
            btn.classList.add('wrong');
            feedback.innerHTML = "<i class='fas fa-times-circle'></i> Kurang tepat. Cuba ingat kata kunci 'Sebab dan Akibat'.";
            feedback.classList.remove('hidden', 'text-green-600'); feedback.classList.add('text-red-600');
        }
    }

    function allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
    function drag(ev) { const target = ev.target.closest('.draggable'); ev.dataTransfer.setData("text", target.id); ev.dataTransfer.effectAllowed = "move"; }
    function drop(ev) {
        ev.preventDefault();
        const zone = ev.currentTarget;
        zone.classList.remove('drag-over');
        const data = ev.dataTransfer.getData("text");
        const draggedElement = document.getElementById(data);
        if(!draggedElement) return;
        const correctTarget = draggedElement.getAttribute('data-target');
        const zoneId = zone.getAttribute('data-zone');

        if(correctTarget === zoneId) {
            zone.innerHTML = ''; zone.appendChild(draggedElement);
            draggedElement.classList.add('matched'); draggedElement.draggable = false;
            zone.classList.add('correct');
            zone.animate([{ transform: 'scale(1)' }, { transform: 'scale(1.1)' }, { transform: 'scale(1)' }], { duration: 300 });
            state.dragScore = (state.dragScore || 0) + 1; saveProgress();
        } else {
            zone.style.backgroundColor = '#fee2e2'; zone.style.borderColor = '#ef4444';
            setTimeout(() => { zone.style.backgroundColor = ''; zone.style.borderColor = ''; }, 500);
        }
    }

    function toggleVocab() { document.getElementById('vocabPanel').classList.toggle('show'); }
    function renderVocab(type) {
        const list = document.getElementById('vocabList');
        if(type === 'istilah') list.innerHTML = vocabData.istilah.map(([k,v]) => `<div class="bg-gray-50 p-2 rounded border mb-2 cursor-pointer hover:bg-orange-50 transition" onclick="insertVocab('${k}')"><strong>${k}</strong>: ${v}</div>`).join('');
        else list.innerHTML = vocabData.kata_kunci.map(k => `<div class="bg-gray-50 p-2 rounded border mb-2 cursor-pointer hover:bg-orange-50 transition" onclick="insertVocab('${k}')">${k}</div>`).join('');
    }

    function insertVocab(text) {
        const active = document.querySelector('textarea:focus');
        if(active) {
            const start = active.selectionStart; const end = active.selectionEnd; const val = active.value;
            active.value = val.substring(0, start) + text + " " + val.substring(end);
            active.selectionStart = active.selectionEnd = start + text.length + 1;
            active.focus();
            saveAnswer(active.id, active.value);
        } else { alert("Sila klik pada kotak jawapan dahulu sebelum memilih perkataan."); }
    }

    function saveAnswer(key, val) { state.answers[key] = val; saveProgress(); }

    init();
  </script>
</body>
</html>
